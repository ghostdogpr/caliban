<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Query optimization | Caliban</title>
    <meta name="generator" content="VuePress 1.8.2">
    <link rel="icon" href="/caliban/caliban.png">
    <meta name="description" content="Functional GraphQL library for Scala">
    
    <link rel="preload" href="/caliban/assets/css/0.styles.5378620b.css" as="style"><link rel="preload" href="/caliban/assets/js/app.86099f15.js" as="script"><link rel="preload" href="/caliban/assets/js/2.bfa611b1.js" as="script"><link rel="preload" href="/caliban/assets/js/16.a4da555a.js" as="script"><link rel="prefetch" href="/caliban/assets/js/10.38f9edbf.js"><link rel="prefetch" href="/caliban/assets/js/11.d4680226.js"><link rel="prefetch" href="/caliban/assets/js/12.a2927852.js"><link rel="prefetch" href="/caliban/assets/js/13.c5d0bc6f.js"><link rel="prefetch" href="/caliban/assets/js/14.742721da.js"><link rel="prefetch" href="/caliban/assets/js/15.a8dac9a5.js"><link rel="prefetch" href="/caliban/assets/js/17.8415a9ba.js"><link rel="prefetch" href="/caliban/assets/js/18.2ff19fb5.js"><link rel="prefetch" href="/caliban/assets/js/19.60515bb0.js"><link rel="prefetch" href="/caliban/assets/js/20.f81c30f7.js"><link rel="prefetch" href="/caliban/assets/js/21.20a95ff5.js"><link rel="prefetch" href="/caliban/assets/js/3.60419601.js"><link rel="prefetch" href="/caliban/assets/js/4.e05c873c.js"><link rel="prefetch" href="/caliban/assets/js/5.76fc70b2.js"><link rel="prefetch" href="/caliban/assets/js/6.498ab014.js"><link rel="prefetch" href="/caliban/assets/js/7.3f5168c2.js"><link rel="prefetch" href="/caliban/assets/js/8.c1aa998a.js"><link rel="prefetch" href="/caliban/assets/js/9.d565ae5e.js">
    <link rel="stylesheet" href="/caliban/assets/css/0.styles.5378620b.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/caliban/" class="home-link router-link-active"><img src="/caliban/caliban.svg" alt="Caliban" class="logo"> <span class="site-name can-hide">Caliban</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/caliban/docs/" class="nav-link router-link-active">
  Documentation
</a></div><div class="nav-item"><a href="/caliban/resources/" class="nav-link">
  Resources
</a></div><div class="nav-item"><a href="/caliban/faq/" class="nav-link">
  FAQ
</a></div><div class="nav-item"><a href="/caliban/about/" class="nav-link">
  About
</a></div><div class="nav-item"><a href="https://github.com/ghostdogpr/caliban" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Github
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div><div class="nav-item"><a href="https://javadoc.io/doc/com.github.ghostdogpr/caliban_2.12/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Scaladoc
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/caliban/docs/" class="nav-link router-link-active">
  Documentation
</a></div><div class="nav-item"><a href="/caliban/resources/" class="nav-link">
  Resources
</a></div><div class="nav-item"><a href="/caliban/faq/" class="nav-link">
  FAQ
</a></div><div class="nav-item"><a href="/caliban/about/" class="nav-link">
  About
</a></div><div class="nav-item"><a href="https://github.com/ghostdogpr/caliban" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Github
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div><div class="nav-item"><a href="https://javadoc.io/doc/com.github.ghostdogpr/caliban_2.12/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Scaladoc
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>Caliban</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/caliban/docs/" aria-current="page" class="sidebar-link">Getting Started</a></li><li><a href="/caliban/docs/schema.html" class="sidebar-link">Schemas</a></li><li><a href="/caliban/docs/middleware.html" class="sidebar-link">Middleware</a></li><li><a href="/caliban/docs/optimization.html" aria-current="page" class="active sidebar-link">Query optimization</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/caliban/docs/optimization.html#introducing-zquery" class="sidebar-link">Introducing ZQuery</a></li><li class="sidebar-sub-header"><a href="/caliban/docs/optimization.html#building-a-datasource" class="sidebar-link">Building a DataSource</a></li><li class="sidebar-sub-header"><a href="/caliban/docs/optimization.html#zquery-constructors-and-operators" class="sidebar-link">ZQuery constructors and operators</a></li><li class="sidebar-sub-header"><a href="/caliban/docs/optimization.html#using-zquery-with-caliban" class="sidebar-link">Using ZQuery with Caliban</a></li><li class="sidebar-sub-header"><a href="/caliban/docs/optimization.html#using-field-metadata" class="sidebar-link">Using field metadata</a></li></ul></li><li><a href="/caliban/docs/validation.html" class="sidebar-link">Validation</a></li><li><a href="/caliban/docs/introspection.html" class="sidebar-link">Introspection</a></li><li><a href="/caliban/docs/interop.html" class="sidebar-link">Interop</a></li><li><a href="/caliban/docs/client.html" class="sidebar-link">GraphQL Client</a></li><li><a href="/caliban/docs/federation.html" class="sidebar-link">Federation</a></li><li><a href="/caliban/docs/tools.html" class="sidebar-link">Tools</a></li><li><a href="/caliban/docs/examples.html" class="sidebar-link">Examples</a></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="query-optimization"><a href="#query-optimization" class="header-anchor">#</a> Query optimization</h1> <p>A GraphQL query may request multiple fields that are using the same resolver. It's not a problem if the resolver is a simple value, but it can be less than optimal when the resolver runs an effect (such as reading from a database).</p> <p>We might want to:</p> <ul><li><strong>cache</strong> identical queries (deduplication)</li> <li><strong>batch</strong> queries to the same source</li></ul> <p>This is possible in Caliban using the <a href="https://github.com/zio/zquery" target="_blank" rel="noopener noreferrer"><code>ZQuery</code><span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> data type.</p> <p>Additionally, one may want to perform optimizations based on the fields selected by the client.
This optimization can be achieved by field metadata from Caliban that can be referenced in your query classes.</p> <h2 id="introducing-zquery"><a href="#introducing-zquery" class="header-anchor">#</a> Introducing ZQuery</h2> <p>A <code>ZQuery[R, E, A]</code> is a purely functional description of an effectual query that may contain requests to one or more data sources. Similarly to <code>ZIO[R, E, A]</code>, it requires an environment <code>R</code>, may fail with an <code>E</code> or succeed with an <code>A</code>. All requests that do not need to be performed sequentially will automatically be batched, allowing for aggressive data source specific optimizations. Requests will also automatically be deduplicated and cached.</p> <p>This allows for writing queries in a high level, compositional style, with confidence that they will automatically be optimized. For example, consider the following query from a user service.</p> <div class="language-scala extra-class"><pre class="language-scala"><code><span class="token keyword">val</span> getAllUserIds<span class="token operator">:</span> ZQuery<span class="token punctuation">[</span><span class="token builtin">Any</span><span class="token punctuation">,</span> <span class="token builtin">Nothing</span><span class="token punctuation">,</span> List<span class="token punctuation">[</span><span class="token builtin">Int</span><span class="token punctuation">]</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token operator">?</span><span class="token operator">?</span><span class="token operator">?</span>
<span class="token keyword">def</span> getUserNameById<span class="token punctuation">(</span>id<span class="token operator">:</span> <span class="token builtin">Int</span><span class="token punctuation">)</span><span class="token operator">:</span> ZQuery<span class="token punctuation">[</span><span class="token builtin">Any</span><span class="token punctuation">,</span> <span class="token builtin">Nothing</span><span class="token punctuation">,</span> <span class="token builtin">String</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token operator">?</span><span class="token operator">?</span><span class="token operator">?</span>

<span class="token keyword">for</span> <span class="token punctuation">{</span>
  userIds   <span class="token keyword">&lt;-</span> getAllUserIds
  userNames <span class="token keyword">&lt;-</span> ZQuery<span class="token punctuation">.</span>foreachPar<span class="token punctuation">(</span>userIds<span class="token punctuation">)</span><span class="token punctuation">(</span>getUserNameById<span class="token punctuation">)</span>
<span class="token punctuation">}</span> <span class="token keyword">yield</span> userNames
</code></pre></div><p>This would normally require N + 1 queries, one for <code>getAllUserIds</code> and one for each call to <code>getUserNameById</code>. In contrast, <code>ZQuery</code> will automatically optimize this to two queries, one for <code>userIds</code> and one for <code>userNames</code>, assuming an implementation of the user service that supports batching.</p> <h2 id="building-a-datasource"><a href="#building-a-datasource" class="header-anchor">#</a> Building a DataSource</h2> <p>To build a <code>ZQuery</code> that executes a request, you first need to build a <code>DataSource</code>. A <code>DataSource[R, E, A]</code> defines how to execute requests of type <code>A</code> and it requires 2 things:</p> <ul><li>an <code>identifier</code> that uniquely identifies the data source (requests from <em>different</em> data sources will <em>not</em> be batched together)</li> <li>a effectful function <code>run</code> from an <code>Iterable</code> of requests to a <code>Map</code> of requests and results</li></ul> <p>Let's consider <code>getUserNameById</code> from the previous example. We need to define a corresponding request type that extends <code>zquery.Request</code> for a given response type:</p> <div class="language-scala extra-class"><pre class="language-scala"><code><span class="token keyword">case</span> <span class="token keyword">class</span> GetUserName<span class="token punctuation">(</span>id<span class="token operator">:</span> <span class="token builtin">Int</span><span class="token punctuation">)</span> <span class="token keyword">extends</span> Request<span class="token punctuation">[</span>Throwable<span class="token punctuation">,</span> <span class="token builtin">String</span><span class="token punctuation">]</span>
</code></pre></div><p>Now let's build the corresponding <code>DataSource</code>. We need to implement the following functions:</p> <div class="language-scala extra-class"><pre class="language-scala"><code><span class="token keyword">val</span> UserDataSource <span class="token operator">=</span> <span class="token keyword">new</span> DataSource<span class="token punctuation">[</span><span class="token builtin">Any</span><span class="token punctuation">,</span> GetUserName<span class="token punctuation">]</span> <span class="token punctuation">{</span>
  <span class="token keyword">override</span> <span class="token keyword">val</span> identifier<span class="token operator">:</span> <span class="token builtin">String</span> <span class="token operator">=</span> <span class="token operator">?</span><span class="token operator">?</span><span class="token operator">?</span>
  <span class="token keyword">override</span> <span class="token keyword">def</span> run<span class="token punctuation">(</span>requests<span class="token operator">:</span> Iterable<span class="token punctuation">[</span>GetUserName<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">:</span> ZIO<span class="token punctuation">[</span><span class="token builtin">Any</span><span class="token punctuation">,</span> Throwable<span class="token punctuation">,</span> CompletedRequestMap<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token operator">?</span><span class="token operator">?</span><span class="token operator">?</span>
<span class="token punctuation">}</span>
</code></pre></div><p>We will use &quot;UserDataSource&quot; as our identifier. This name should not be reused for other data sources.</p> <div class="language-scala extra-class"><pre class="language-scala"><code><span class="token keyword">override</span> <span class="token keyword">val</span> identifier<span class="token operator">:</span> <span class="token builtin">String</span> <span class="token operator">=</span> <span class="token string">&quot;UserDataSource&quot;</span>
</code></pre></div><p>We will define two different behaviors depending on whether we receive a single request or multiple requests at once.
For each request, we need to insert into the result map a value of type <code>Either</code> (<code>Left</code> for an error and <code>Right</code> for a success).</p> <div class="language-scala extra-class"><pre class="language-scala"><code><span class="token keyword">override</span> <span class="token keyword">def</span> run<span class="token punctuation">(</span>requests<span class="token operator">:</span> Iterable<span class="token punctuation">[</span>GetUserName<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">:</span> ZIO<span class="token punctuation">[</span><span class="token builtin">Any</span><span class="token punctuation">,</span> <span class="token builtin">Nothing</span><span class="token punctuation">,</span> CompletedRequestMap<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token keyword">val</span> resultMap <span class="token operator">=</span> CompletedRequestMap<span class="token punctuation">.</span>empty
  requests<span class="token punctuation">.</span>toList <span class="token keyword">match</span> <span class="token punctuation">{</span>
    <span class="token keyword">case</span> request <span class="token operator">::</span> Nil <span class="token keyword">=&gt;</span>
      <span class="token comment">// get user by ID e.g. SELECT name FROM users WHERE id = $id</span>
      <span class="token keyword">val</span> result<span class="token operator">:</span> Task<span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token operator">?</span><span class="token operator">?</span><span class="token operator">?</span>
      result<span class="token punctuation">.</span>either<span class="token punctuation">.</span>map<span class="token punctuation">(</span>resultMap<span class="token punctuation">.</span>insert<span class="token punctuation">(</span>request<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">case</span> batch <span class="token keyword">=&gt;</span>
      <span class="token comment">// get multiple users at once e.g. SELECT id, name FROM users WHERE id IN ($ids)</span>
      <span class="token keyword">val</span> result<span class="token operator">:</span> Task<span class="token punctuation">[</span>List<span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token builtin">Int</span><span class="token punctuation">,</span> <span class="token builtin">String</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token operator">?</span><span class="token operator">?</span><span class="token operator">?</span>
      result<span class="token punctuation">.</span>fold<span class="token punctuation">(</span>
        err <span class="token keyword">=&gt;</span> requests<span class="token punctuation">.</span>foldLeft<span class="token punctuation">(</span>resultMap<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token keyword">case</span> <span class="token punctuation">(</span>map<span class="token punctuation">,</span> req<span class="token punctuation">)</span> <span class="token keyword">=&gt;</span> map<span class="token punctuation">.</span>insert<span class="token punctuation">(</span>req<span class="token punctuation">)</span><span class="token punctuation">(</span>Left<span class="token punctuation">(</span>err<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
        _<span class="token punctuation">.</span>foldLeft<span class="token punctuation">(</span>resultMap<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token keyword">case</span> <span class="token punctuation">(</span>map<span class="token punctuation">,</span> <span class="token punctuation">(</span>id<span class="token punctuation">,</span> name<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">=&gt;</span> map<span class="token punctuation">.</span>insert<span class="token punctuation">(</span>GetUserName<span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">(</span>Right<span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">}</span>
      <span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>Now to build a <code>ZQuery</code> from it, we can use <code>ZQuery.fromRequest</code> and just pass the request and the data source:</p> <div class="language-scala extra-class"><pre class="language-scala"><code><span class="token keyword">def</span> getUserNameById<span class="token punctuation">(</span>id<span class="token operator">:</span> <span class="token builtin">Int</span><span class="token punctuation">)</span><span class="token operator">:</span> ZQuery<span class="token punctuation">[</span><span class="token builtin">Any</span><span class="token punctuation">,</span> Throwable<span class="token punctuation">,</span> <span class="token builtin">String</span><span class="token punctuation">]</span> <span class="token operator">=</span>
  ZQuery<span class="token punctuation">.</span>fromRequest<span class="token punctuation">(</span>GetUserName<span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">(</span>UserDataSource<span class="token punctuation">)</span>
</code></pre></div><p>To run a <code>ZQuery</code>, simply use <code>ZQuery#run</code> which will return a <code>ZIO[R, E, A]</code>.</p> <h2 id="zquery-constructors-and-operators"><a href="#zquery-constructors-and-operators" class="header-anchor">#</a> ZQuery constructors and operators</h2> <p>There are several ways to create a <code>ZQuery</code>. We've seen <code>ZQuery.fromRequest</code>, but you can also:</p> <ul><li>create from a pure value with <code>ZQuery.succeed</code></li> <li>create from an effect value with <code>ZQuery.fromEffect</code></li> <li>create from multiple queries with <code>ZQuery.collectAllPar</code> and <code>ZQuery.foreachPar</code> and their sequential equivalents <code>ZQuery.collectAll</code> and <code>ZQuery.foreach</code></li></ul> <p>If you have a <code>ZQuery</code> object, you can use:</p> <ul><li><code>map</code> and <code>mapError</code> to modify the returned result or error</li> <li><code>flatMap</code> or <code>zip</code> to combine it with other <code>ZQuery</code> objects</li> <li><code>provide</code> and <code>provideSome</code> to eliminate some of the <code>R</code> requirements</li></ul> <p>There are several ways to run a <code>ZQuery</code>:</p> <ul><li><code>runCache</code> runs the query using a given pre-populated cache. This can be useful for deterministically &quot;replaying&quot; a query without executing any new requests.</li> <li><code>runLog</code> runs the query and returns its result along with the cache containing a complete log of all requests executed and their results. This can be useful for logging or analysis of query execution.</li> <li><code>run</code> runs the query and returns its result.</li></ul> <h2 id="using-zquery-with-caliban"><a href="#using-zquery-with-caliban" class="header-anchor">#</a> Using ZQuery with Caliban</h2> <p>To use <code>ZQuery</code> with Caliban, you can simply include fields of type <code>ZQuery</code> in your API definition.</p> <div class="language-scala extra-class"><pre class="language-scala"><code><span class="token keyword">case</span> <span class="token keyword">class</span> Queries<span class="token punctuation">(</span>
  users<span class="token operator">:</span> ZQuery<span class="token punctuation">[</span><span class="token builtin">Any</span><span class="token punctuation">,</span> <span class="token builtin">Nothing</span><span class="token punctuation">,</span> List<span class="token punctuation">[</span>User<span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
  user<span class="token operator">:</span> UserArgs <span class="token keyword">=&gt;</span> ZQuery<span class="token punctuation">[</span><span class="token builtin">Any</span><span class="token punctuation">,</span> <span class="token builtin">Nothing</span><span class="token punctuation">,</span> User<span class="token punctuation">]</span><span class="token punctuation">)</span>
</code></pre></div><p>During the query execution, Caliban will merge all the requested fields that return a <code>ZQuery</code> into a single <code>ZQuery</code> and run it, so that all the possible optimizations are applied.</p> <p>The <a href="https://github.com/ghostdogpr/caliban/tree/master/examples" target="_blank" rel="noopener noreferrer">examples<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> project provides 2 versions of the problem described in <a href="https://blog.apollographql.com/optimizing-your-graphql-request-waterfalls-7c3f3360b051" target="_blank" rel="noopener noreferrer">this article about GraphQL query optimization<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>:</p> <ul><li>a <a href="https://github.com/ghostdogpr/caliban/tree/master/examples/src/main/scala/example/optimizations/NaiveTest.scala" target="_blank" rel="noopener noreferrer">naive<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> version where fields are just returning <code>IO</code>, resulting in 47 requests</li> <li>an <a href="https://github.com/ghostdogpr/caliban/tree/master/examples/src/main/scala/example/optimizations/OptimizedTest.scala" target="_blank" rel="noopener noreferrer">optimized<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> version where fields are returning <code>ZQuery</code>, resulting in 8 requests only</li></ul> <div class="custom-block tip"><p class="custom-block-title">TIP</p> <p>When all your effects are wrapped with <code>ZQuery.fromRequest</code>, it is recommended to use <code>queryExecution = QueryExecution.Batched</code> instead of the default <code>QueryExecution.Parallel</code>.
Doing so will provide better performance as it will avoid forking unnecessary fibers.
This setting is available in <code>executeRequest</code> as well as all the adapters.</p></div> <h2 id="using-field-metadata"><a href="#using-field-metadata" class="header-anchor">#</a> Using field metadata</h2> <p>To reference field metadata in your queries you can simply use a function that takes the <code>caliban.execution.Field</code> type in your queries.</p> <div class="language-scala extra-class"><pre class="language-scala"><code><span class="token keyword">case</span> <span class="token keyword">class</span> User<span class="token punctuation">(</span>name<span class="token operator">:</span> <span class="token builtin">String</span><span class="token punctuation">,</span> expensiveOperation<span class="token operator">:</span> <span class="token builtin">String</span><span class="token punctuation">)</span>
<span class="token keyword">case</span> <span class="token keyword">class</span> Queries<span class="token punctuation">(</span>
  user<span class="token operator">:</span> Field <span class="token keyword">=&gt;</span> User
<span class="token punctuation">)</span>
</code></pre></div><p>You can also do this with functions that take inputs.</p> <div class="language-scala extra-class"><pre class="language-scala"><code><span class="token keyword">case</span> <span class="token keyword">class</span> UserInput<span class="token punctuation">(</span>id<span class="token operator">:</span> <span class="token builtin">String</span><span class="token punctuation">)</span>
<span class="token keyword">case</span> <span class="token keyword">class</span> User<span class="token punctuation">(</span>name<span class="token operator">:</span> <span class="token builtin">String</span><span class="token punctuation">,</span> expensiveOperation<span class="token operator">:</span> <span class="token builtin">String</span><span class="token punctuation">)</span>
<span class="token keyword">case</span> <span class="token keyword">class</span> Queries<span class="token punctuation">(</span>
  user<span class="token operator">:</span> Field <span class="token keyword">=&gt;</span> <span class="token punctuation">(</span>UserInput <span class="token keyword">=&gt;</span> User<span class="token punctuation">)</span>
<span class="token punctuation">)</span>
</code></pre></div><p>In the resulting GraphQL Schema the <em>Field</em> will be ignored giving you the equivalent of just the returned type of the function.</p> <p>The implementation of the function can then take the field metadata into account for optimization.
For instance one could modify a database query to only select certain columns or do joins to additional tables depending on what the client requests.</p> <p>For example:</p> <div class="language-scala extra-class"><pre class="language-scala"><code>Queries<span class="token punctuation">(</span> <span class="token punctuation">(</span>field<span class="token punctuation">)</span> <span class="token keyword">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span><span class="token punctuation">(</span>field<span class="token punctuation">.</span>fields<span class="token punctuation">.</span>map<span class="token punctuation">(</span>_<span class="token punctuation">.</span>name<span class="token punctuation">)</span><span class="token punctuation">.</span>contains<span class="token punctuation">(</span><span class="token string">&quot;expensiveOperation&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    expensiveUserRequest<span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    efficientUserRequest<span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/caliban/docs/middleware.html" class="prev">
        Middleware
      </a></span> <span class="next"><a href="/caliban/docs/validation.html">
        Validation
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/caliban/assets/js/app.86099f15.js" defer></script><script src="/caliban/assets/js/2.bfa611b1.js" defer></script><script src="/caliban/assets/js/16.a4da555a.js" defer></script>
  </body>
</html>
